<!DOCTYPE html>
<html lang="zh-hant-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>消息中心</title>
    <link th:href="@{/css/bootstrap.min.css}" rel="stylesheet">
    <link th:href="@{/css/custom.css}" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <script th:src="@{/js/bootstrap.bundle.min.js}"></script>
    <script th:src="@{/js/jquery.min.js}"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
        }

        .main-content {
            display: flex;
            height: 100vh;
        }

		.accordion-item {
		    margin: 0; /* 移除多餘的外間距 */
		    width: 100%; /* 寬度擴展至容器邊界 */
		}
		
		#messageAccordion {
		    width: 100%; /* Accordion 容器同樣佔據整個寬度 */
		}
		
		#mainContent {
		    flex: 1; /* 確保內容區域可靈活拉伸 */
		    padding: 20px; /* 添加間距確保內容不緊貼邊界 */
		    background-color: #fff; /* 可選：設置背景顏色 */
		    box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.1); /* 可選：添加陰影效果 */
		}

        
        
    </style>
</head>

<body>
    <!-- 引入 userHeader -->
    <div th:replace="~{Customer_Service/layout/userHeader}"></div>

    <!-- Flexbox -->
    <div class="d-flex" style="height: 100vh;">
        <!-- 引入側邊欄 -->
        <div th:replace="~{Customer_Service/layout/memberCenterSidebar}"></div>

        <!-- 主要內容 -->
        <div id="mainContent" class="p-4">
            <h2 class="form-title">消息中心</h2>
            <input type="hidden" id="currentUserId" th:value="${userId}">
            <div id="contentArea">
                <div class="accordion" id="messageAccordion">
                    <!-- 消息會動態插入這裡 -->
                </div>
            </div>
        </div>
    </div>

    <!-- footer -->
    <div th:replace="~{Customer_Service/html/footer}"></div>

    <!-- script -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js" 
            integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy" 
            crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.js" 
            integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" 
            crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
    function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('zh-TW');
}

function loadMessages() {
    // 先檢查登入狀態
    axios.get('/messages/checkLogin')
        .then(response => {
            if (!response.data || !response.data.userId) {
                throw new Error('未登入');
            }
            
            const userId = response.data.userId;
            // 使用從登入狀態取得的 userId 來獲取訊息
            return axios.get(`/messages/messages/user/${userId}`);
        })
        .then(function(response) {
            const messages = response.data;
            let contentHtml = '';

            if (messages && messages.length > 0) {
                messages.forEach(function(message) {
                    contentHtml += `
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" 
                                        data-bs-toggle="collapse" 
                                        data-bs-target="#collapse${message.messageId}">
                                    <div class="d-flex justify-content-between w-100">
                                        <div>
                                            <span class="badge bg-primary me-2">${message.messageSort || '未分類'}</span>
                                            <span>${message.messageTitle}</span>
                                        </div>
                                        <span class="ms-auto">${formatDate(message.messageDate)}</span>
                                    </div>
                                </button>
                            </h2>
                            <div id="collapse${message.messageId}" 
                                 class="accordion-collapse collapse" 
                                 data-bs-parent="#messageAccordion">
                                <div class="accordion-body">
                                    ${message.messageContent}
                                </div>
                            </div>
                        </div>
                    `;
                });
            } else {
                contentHtml = '<div class="alert alert-info">目前沒有任何訊息</div>';
            }

            document.querySelector('#messageAccordion').innerHTML = contentHtml;
        })
        .catch(function(error) {
            console.error('載入訊息失敗:', error);
            let errorMessage = '載入訊息時發生錯誤';
            
            if (error.response) {
                if (error.response.status === 401) {
                    errorMessage = '請先登入後再試';
                    window.location.href = '/login';  // 重導向到登入頁面
                } else if (error.response.data) {
                    errorMessage = error.response.data;
                }
            } else if (error.message) {
                errorMessage = error.message;
            }
            
            document.querySelector('#contentArea').innerHTML = 
                `<div class="alert alert-danger">${errorMessage}</div>`;
        });
}

// 格式化日期的函數
function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('zh-TW', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'
    });
}

// 頁面載入時執行
document.addEventListener('DOMContentLoaded', loadMessages);
    </script>
</body>
</html>
